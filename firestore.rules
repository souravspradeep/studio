/**
 * @file Firestore and Storage Security Rules
 * @description This ruleset enforces user ownership for profiles, public-read/owner-write for items, and authenticated-write for image uploads.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.
 * - /lostItems/{lostItemId}: Stores lost item posts.
 * - /foundItems/{foundItemId}: Stores found item posts.
 *
 * Storage Structure:
 * - /items/{itemId} - Stores images for lost and found items.
 *
 * Key Security Decisions:
 * - Firestore: User data is private; item data is public to read but write-restricted to owners.
 * - Storage: Any authenticated user can write to the 'items/' path. Reads are public. This is a common pattern for user-uploaded content.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to lost item posts.
     */
    match /lostItems/{lostItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Controls access to found item posts.
     */
    match /foundItems/{foundItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }
  }

  // Helper functions for Firestore
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    /**
     * @description Controls access to image uploads for items.
     * @path /items/{itemId}
     * @allow (read) Anyone can read images.
     * @allow (write) Any authenticated user can upload an image.
     * @principle Allow public read for displaying images and restrict writes to logged-in users to prevent anonymous abuse.
     */
    match /items/{itemId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}
